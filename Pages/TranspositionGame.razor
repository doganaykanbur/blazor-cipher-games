@page "/transposition"
@inject IJSRuntime JSRuntime
@inject LanguageService L
@inject SettingsService Settings
@implements IDisposable

<div class="game-wrapper">
    <div class="game-nav">
        <a class="game-btn" href="/">@L["menu_playfair"]</a>
        <a class="game-btn" href="/caesar">@L["menu_caesar"]</a>
        <a class="game-btn" href="/hill">@L["menu_hill"]</a>
        <a class="game-btn" href="/vigenere">@L["menu_vigenere"]</a>
        <a class="game-btn active" href="/transposition">@L["menu_transposition"]</a>
        <a class="game-btn" href="/monoalphabetic">@L["menu_monoalphabetic"]</a>
    </div>

    @if (!HasStarted)
    {
        <div class="start-screen">
            <img src="images/transposition.svg" alt="Transposition" class="game-logo" />
            <h1 class="game-title">@L["transposition_title"]</h1>
            <div class="tagline">@L["transposition_tagline"]</div>
            <p class="intro-text">@L["transposition_intro"]</p>
            <button class="start-button" @onclick="StartGame">@L["start"]</button>
            <div class="start-cta">@L["transposition_start_cta"]</div>
        </div>
    }
    else
    {
        <div class="game-container">
            <div class="info-box">
                <div class="mode-badge">@(IsEncode ? L["encode_mode"] : L["decode_mode"])</div>
                <div class="keyword-box">@L["keyword_label"] <span class="keyword">@Keyword</span></div>
            </div>

            <div class="question-box">@QuestionText</div>

            <div class="answer-container">
                <input class="answer-input" placeholder="@L["your_answer_placeholder"]" @bind="UserAnswer" />
                @if (CharacterValidation.Count > 0)
                {
                    <div class="character-validation">
                        @for (int i = 0; i < CharacterValidation.Count; i++)
                        {
                            <span class="char @(CharacterValidation[i] ? "correct-char" : "wrong-char")">
                                @(i < UserAnswer.Length ? UserAnswer[i].ToString().ToUpper() : "")
                            </span>
                        }
                    </div>
                }
            </div>

            <div class="button-group">
                <button class="action-button" @onclick="CheckAnswer">@L["check"]</button>
                <button class="action-button" @onclick="ShowAnswer">@L["show_answer"]</button>
            </div>

            @if (ResultMessage is not null && !ShowModal)
            {
                <div class="@($"result {(IsCorrect ? "correct" : "wrong")}")">@ResultMessage</div>
            }

            @if (ShowModal)
            {
                <div class="modal-overlay" @onclick="CloseModal">
                    <div class="modal-content" @onclick:stopPropagation="true">
                        <div class="modal-header">
                            <h2 class="modal-title">@L["result_title"]</h2>
                            <button class="modal-close" @onclick="CloseModal">&times;</button>
                        </div>

                        <div class="modal-body">
                            <div class="performance-info">
                                <div class="performance-text" style="color: @GetPerformanceColor()">
                                    @ModalPerformanceText
                                </div>
                                <div class="performance-details">
                                    <div class="detail-item">
                                        <span class="detail-label">@L["error_count"]</span>
                                        <span class="detail-value">@ErrorCount</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">@L["total_attempts"]</span>
                                        <span class="detail-value">@TotalAttempts</span>
                                    </div>
                                </div>
                            </div>

                            @if (ShowPercentage)
                            {
                                <div class="percentage-display">
                                    <div class="percentage-label" id="percentageText" style="color: @GetPerformanceColor()">0%</div>
                                </div>
                            }

                            @if (ShowAnswerInModal)
                            {
                                <div class="correct-answer-box">@L["correct_answer"] @CorrectAnswer</div>
                            }
                        </div>

                        <div class="modal-footer">
                            <button class="modal-button" @onclick="NextQuestionFromModal">@L["continue"]</button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private bool HasStarted = false;
    private TranspositionCipher? cipher;
    private string Keyword = string.Empty;
    private string QuestionText = string.Empty;
    private string BaseText = string.Empty;
    private string EncodedText = string.Empty;
    private string UserAnswer = string.Empty;
    private string CorrectAnswer = string.Empty;
    private string? ResultMessage;
    private bool IsCorrect;
    private bool IsEncode;
    private List<bool> CharacterValidation = new();
    private int CorrectPercentage = 0;
    private bool ShowPercentage = false;
    private bool ShowModal = false;
    private int ErrorCount = 0;
    private int TotalAttempts = 0;

    // Modal
    private string ModalPerformanceText = string.Empty;
    private bool ShowAnswerInModal = false;

    private void StartGame()
    {
        HasStarted = true;
        NextQuestion();
    }

    private void NextQuestion()
    {
        ResultMessage = null;
        UserAnswer = string.Empty;
        CharacterValidation.Clear();
        ShowPercentage = false;
        CorrectPercentage = 0;
        ShowModal = false;
        ShowAnswerInModal = false;

        Keyword = GenerateRandomKeyword();
        cipher = new TranspositionCipher(Keyword);

        IsEncode = Random.Shared.Next(2) == 0;
        BaseText = GetRandomPhrase();
        EncodedText = cipher.Encode(BaseText);

        if (IsEncode)
        {
            QuestionText = $"{L["encode_word"]} {BaseText}";
            CorrectAnswer = EncodedText;
        }
        else
        {
            QuestionText = $"{L["decode_word"]} {EncodedText}";
            CorrectAnswer = cipher.Decode(EncodedText);
        }
    }

    private void CheckAnswer()
    {
        CharacterValidation.Clear();
        TotalAttempts++;

        var user = new string(UserAnswer.ToUpper().Where(ch => ch != ' ').ToArray());
        var correct = CorrectAnswer.ToUpper();

        int maxLength = Math.Max(user.Length, correct.Length);
        int correctCount = 0;
        for (int i = 0; i < maxLength; i++)
        {
            bool ok = i < user.Length && i < correct.Length && user[i] == correct[i];
            CharacterValidation.Add(ok);
            if (ok) correctCount++;
        }

        CorrectPercentage = maxLength > 0 ? (correctCount * 100) / maxLength : 0;
        IsCorrect = string.Equals(user, correct, StringComparison.OrdinalIgnoreCase);

        if (IsCorrect)
        {
            ShowAnswerInModal = false;
            ShowModal = true;
            ShowPercentage = true;
            SetModalPerformance();
            StateHasChanged();
            JSRuntime.InvokeVoidAsync("animatePercentage", CorrectPercentage);
        }
        else
        {
            ErrorCount++;
            ResultMessage = L["wrong_try_again"];
        }
    }

    private void ShowAnswer()
    {
        ShowModal = true;
        ShowPercentage = true;
        ShowAnswerInModal = true;
        CorrectPercentage = 0;
        ModalPerformanceText = L["didnt_guess"];
        StateHasChanged();
        JSRuntime.InvokeVoidAsync("animatePercentage", CorrectPercentage);
    }

    private void NextQuestionFromModal()
    {
        NextQuestion();
    }

    private void CloseModal()
    {
        ShowModal = false;
        ShowPercentage = false;
        ShowAnswerInModal = false;
    }

    private void SetModalPerformance()
    {
        if (CorrectPercentage == 100)
        {
            ModalPerformanceText = L["performance_perfect"];
        }
        else if (CorrectPercentage >= 70)
        {
            ModalPerformanceText = L["performance_good"];
        }
        else if (CorrectPercentage >= 40)
        {
            ModalPerformanceText = L["performance_medium"];
        }
        else
        {
            ModalPerformanceText = L["performance_bad"];
        }
    }

    private string GetPerformanceColor()
    {
        if (ShowAnswerInModal) return "#ff4444";
        if (CorrectPercentage == 100) return "#00ff00";
        if (CorrectPercentage >= 70) return "#ffff00";
        if (CorrectPercentage >= 40) return "#ff8800";
        return "#ff4444";
    }

    private string GenerateRandomKeyword()
    {
        string[] words = { "KEY", "SECRET", "CIPHER", "MATRIX", "COLUMN", "ORDER", "CRYPTO", "SECURE", "CLEVER", "SMART" };
        return words[Random.Shared.Next(words.Length)];
    }

    private string GetRandomPhrase()
    {
        string[] words = { "HELLO", "WORLD", "SECRET", "CIPHER", "ENCRYPT", "DECODE", "CRYPTO", "SECURE", "CLEVER", "BRAIN", "SMART", "QUICK", "COOL", "NICE", "CODE", "GAME", "TEST", "QUIZ" };
        int count = Settings.Current == PlayfairGame.Difficulty.Easy ? 1 : (Settings.Current == PlayfairGame.Difficulty.Normal ? 2 : 3);
        var list = new List<string>();
        for (int i = 0; i < count; i++) list.Add(words[Random.Shared.Next(words.Length)]);
        return string.Join(" ", list);
    }
}
@code {
    protected override void OnInitialized()
    {
        L.OnChange += OnLanguageChanged;
    }

    public void Dispose()
    {
        L.OnChange -= OnLanguageChanged;
    }

    private void OnLanguageChanged()
    {
        if (!HasStarted) { StateHasChanged(); return; }
        if (IsEncode)
            QuestionText = $"{L["encode_word"]} {BaseText}";
        else
            QuestionText = $"{L["decode_word"]} {EncodedText}";
        StateHasChanged();
    }
}
